/* truncated for brevity; full JS included earlier */